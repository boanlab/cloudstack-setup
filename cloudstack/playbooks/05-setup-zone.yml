---
# CloudStack Zone 설정 (리스트 기반)
- name: Setup CloudStack Zone
  hosts: localhost
  connection: local
  gather_facts: no
  vars_files:
    - ../inventory/group_vars/zone.yml
  
  tasks:
    - name: Check if API keys are configured
      fail:
        msg: |
          API Key가 설정되지 않았습니다!
          
          1. Web UI 접속: http://{{ hostvars[groups['management'][0]]['ansible_host'] }}:8080/client
          2. admin / password 로그인
          3. Accounts → admin → View Users
          4. admin 클릭 → Keys 탭
          5. Generate Keys 클릭
          6. 생성된 키를 inventory/group_vars/zone.yml의 cs_api_key와 cs_api_secret에 입력
      when: cs_api_key == "" or cs_api_secret == ""
    
    - name: Install CloudStack Ansible collection dependencies
      apt:
        name:
          - python3-cs
        state: present
      delegate_to: localhost
      become: yes
    
    # Zone 생성
    - name: Create Zone
      ngine_io.cloudstack.cs_zone:
        api_url: "{{ cs_api_url }}"
        api_key: "{{ cs_api_key }}"
        api_secret: "{{ cs_api_secret }}"
        api_timeout: 60
        name: "{{ zone_name }}"
        dns1: "{{ zone_dns1 }}"
        dns2: "{{ zone_dns2 }}"
        internal_dns1: "{{ zone_internal_dns1 }}"
        internal_dns2: "{{ zone_internal_dns2 }}"
        network_type: "{{ zone_network_type }}"
        guest_cidr_address: "{{ zone_guest_cidr | default(omit) }}"
        state: present
      register: zone
    
    - name: Display Zone info
      debug:
        msg: "Zone created: {{ zone.name }} (ID: {{ zone.id }})"
    
    # Physical Networks 생성 및 구성 (리스트)
    - name: Create Physical Networks
      ngine_io.cloudstack.cs_physical_network:
        api_url: "{{ cs_api_url }}"
        api_key: "{{ cs_api_key }}"
        api_secret: "{{ cs_api_secret }}"
        api_timeout: 60
        name: "{{ item.name }}"
        zone: "{{ zone_name }}"
        isolation_method: "{{ item.isolation_methods }}"
        vlan: "{{ item.vlan_range | default(omit) }}"
        state: present
      loop: "{{ cloudstack_physical_networks }}"
      register: physical_networks_result
    
    - name: Display Physical Networks info
      debug:
        msg: "Physical Networks created: {{ physical_networks_result.results | map(attribute='name') | list }}"
    
    # Traffic Types 추가 (각 Physical Network에 대해)
    - name: Add Traffic Types to Physical Networks
      ngine_io.cloudstack.cs_traffic_type:
        api_url: "{{ cs_api_url }}"
        api_key: "{{ cs_api_key }}"
        api_secret: "{{ cs_api_secret }}"
        api_timeout: 60
        physical_network: "{{ item.0.name }}"
        zone: "{{ zone_name }}"
        traffic_type: "{{ item.1.type }}"
        kvm_networklabel: "{{ item.1.kvm_networklabel }}"
        state: present
      loop: "{{ cloudstack_physical_networks | subelements('traffic_types') }}"
      loop_control:
        label: "{{ item.0.name }} - {{ item.1.type }}"
      register: traffic_types_result
    
    - name: Display Traffic Types info
      debug:
        msg: "Traffic Types configured: {{ traffic_types_result.results | length }}"
    
    - name: Enable Physical Networks
      ngine_io.cloudstack.cs_physical_network:
        api_url: "{{ cs_api_url }}"
        api_key: "{{ cs_api_key }}"
        api_secret: "{{ cs_api_secret }}"
        api_timeout: 60
        name: "{{ item.name }}"
        zone: "{{ zone_name }}"
        state: enabled
      loop: "{{ cloudstack_physical_networks }}"
      register: enable_networks_result
    
    - name: Display Physical Networks enable status
      debug:
        msg: "Physical Networks enabled: {{ enable_networks_result.results | map(attribute='name') | list }}"
    
    # Public IP 범위 추가 (for_virtual_network=true)
    - name: Add Public IP Ranges
      ngine_io.cloudstack.cs_vlan_ip_range:
        api_url: "{{ cs_api_url }}"
        api_key: "{{ cs_api_key }}"
        api_secret: "{{ cs_api_secret }}"
        api_timeout: 60
        zone: "{{ zone_name }}"
        physical_network: "{{ item.physical_network_name }}"
        start_ip: "{{ item.start_ip }}"
        end_ip: "{{ item.end_ip }}"
        gateway: "{{ item.gateway }}"
        netmask: "{{ item.netmask }}"
        vlan: "{{ item.vlan }}"
        for_virtual_network: true
        state: present
      loop: "{{ cloudstack_public_ip_ranges }}"
      register: public_ip_ranges_result
    
    - name: Display Public IP Ranges info
      debug:
        msg: "Public IP Ranges added: {{ public_ip_ranges_result.results | length }} range(s)"
    
    # Pods 생성 (리스트)
    - name: Create Pods
      ngine_io.cloudstack.cs_pod:
        api_url: "{{ cs_api_url }}"
        api_key: "{{ cs_api_key }}"
        api_secret: "{{ cs_api_secret }}"
        api_timeout: 60
        name: "{{ item.name }}"
        zone: "{{ zone_name }}"
        start_ip: "{{ item.start_ip }}"
        end_ip: "{{ item.end_ip }}"
        gateway: "{{ item.gateway }}"
        netmask: "{{ item.netmask }}"
        state: present
      loop: "{{ cloudstack_pods }}"
      register: pods_result
    
    - name: Display Pods info
      debug:
        msg: "Pods created: {{ pods_result.results | map(attribute='name') | list }}"
    
    # Clusters 생성 (리스트)
    - name: Create Clusters
      ngine_io.cloudstack.cs_cluster:
        api_url: "{{ cs_api_url }}"
        api_key: "{{ cs_api_key }}"
        api_secret: "{{ cs_api_secret }}"
        api_timeout: 60
        name: "{{ item.name }}"
        zone: "{{ zone_name }}"
        pod: "{{ item.pod_name }}"
        hypervisor: "{{ item.hypervisor }}"
        cluster_type: "{{ item.cluster_type }}"
        state: present
      loop: "{{ cloudstack_clusters }}"
      register: clusters_result
    
    - name: Display Clusters info
      debug:
        msg: "Clusters created: {{ clusters_result.results | map(attribute='name') | list }}"
    
    # Hosts 추가 (리스트)
    - name: Add KVM Hosts
      ngine_io.cloudstack.cs_host:
        api_url: "{{ cs_api_url }}"
        api_key: "{{ cs_api_key }}"
        api_secret: "{{ cs_api_secret }}"
        api_timeout: 120
        name: "{{ item.name }}"
        cluster: "{{ item.cluster_name }}"
        zone: "{{ zone_name }}"
        pod: "{{ item.pod_name }}"
        hypervisor: "KVM"
        url: "http://{{ item.ip }}"
        username: "{{ item.username }}"
        password: "{{ item.password }}"
        state: present
      loop: "{{ cloudstack_hosts }}"
      loop_control:
        label: "{{ item.name }} ({{ item.ip }})"
      register: hosts_result
      failed_when:
        - hosts_result.failed is defined
        - hosts_result.failed
        - "'already in the database' not in (hosts_result.msg | default(''))"
    
    - name: Display Hosts info
      debug:
        msg: "Hosts processed: {{ hosts_result.results | length }} (some may have been skipped if already existing)"
    
    # Primary Storage 추가 (리스트)
    - name: Add Primary Storages
      ngine_io.cloudstack.cs_storage_pool:
        api_url: "{{ cs_api_url }}"
        api_key: "{{ cs_api_key }}"
        api_secret: "{{ cs_api_secret }}"
        api_timeout: 180
        name: "{{ item.name }}"
        zone: "{{ zone_name }}"
        pod: "{{ item.pod_name }}"
        cluster: "{{ item.cluster_name }}"
        storage_url: "nfs://{{ item.server }}{{ item.path }}"
        scope: "{{ item.scope }}"
        state: present
      loop: "{{ cloudstack_primary_storages }}"
      loop_control:
        label: "{{ item.name }}"
      register: primary_storages_result
    
    - name: Display Primary Storages info
      debug:
        msg: "Primary Storages added: {{ primary_storages_result.results | map(attribute='name') | list }}"
    
    # Secondary Storage 추가 (리스트)
    - name: Add Secondary Storages
      ngine_io.cloudstack.cs_image_store:
        api_url: "{{ cs_api_url }}"
        api_key: "{{ cs_api_key }}"
        api_secret: "{{ cs_api_secret }}"
        api_timeout: 180
        name: "{{ item.name }}"
        provider: "{{ item.provider }}"
        zone: "{{ zone_name }}"
        url: "nfs://{{ item.server }}{{ item.path }}"
        state: present
      loop: "{{ cloudstack_secondary_storages }}"
      loop_control:
        label: "{{ item.name }}"
      register: secondary_storages_result
    
    - name: Display Secondary Storages info
      debug:
        msg: "Secondary Storages added: {{ secondary_storages_result.results | map(attribute='name') | list }}"
    
    - name: Display setup summary
      debug:
        msg:
          - "============================================"
          - "CloudStack Zone Setup Complete!"
          - "============================================"
          - "Zone: {{ zone_name }} (ID: {{ zone.id }})"
          - "Physical Networks: {{ physical_networks_result.results | length }}"
          - "Traffic Types: {{ traffic_types_result.results | length }}"
          - "Public IP Ranges: {{ public_ip_ranges_result.results | length }}"
          - "Pods: {{ pods_result.results | length }}"
          - "Clusters: {{ clusters_result.results | length }}"
          - "Hosts: {{ hosts_result.results | length }}"
          - "Primary Storages: {{ primary_storages_result.results | length }}"
          - "Secondary Storages: {{ cloudstack_secondary_storages | length }}"
          - "============================================"
          - "Web UI: {{ cs_api_url | regex_replace('/client/api', '/client') }}"
          - "============================================"
