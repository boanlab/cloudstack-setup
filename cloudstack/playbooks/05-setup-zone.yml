---
# CloudStack Zone 설정 (리스트 기반)
- name: Setup CloudStack Zone
  hosts: localhost
  connection: local
  gather_facts: no
  vars_files:
    - ../inventory/group_vars/zone.yml
  
  tasks:
    - name: Check if API keys are configured
      fail:
        msg: |
          API Key가 설정되지 않았습니다!
          
          1. Web UI 접속: http://{{ hostvars[groups['management'][0]]['ansible_host'] }}:8080/client
          2. admin / password 로그인
          3. Accounts → admin → View Users
          4. admin 클릭 → Keys 탭
          5. Generate Keys 클릭
          6. 생성된 키를 inventory/group_vars/zone.yml의 cs_api_key와 cs_api_secret에 입력
      when: cs_api_key == "" or cs_api_secret == ""
    
    - name: Install CloudStack Ansible collection dependencies
      apt:
        name:
          - python3-cs
        state: present
      delegate_to: localhost
      become: yes
    
    # Zone 조회 및 생성
    - name: Check if Zone exists
      uri:
        url: "{{ cs_api_url }}?command=listZones&name={{ zone_name }}&response=json"
        method: GET
        headers:
          X-API-Key: "{{ cs_api_key }}"
          X-Secret-Key: "{{ cs_api_secret }}"
        return_content: yes
        status_code: 200
      register: existing_zone
      failed_when: false
    
    - name: Set zone facts
      set_fact:
        zone_exists: "{{ existing_zone.json.listzonesresponse.zone is defined and existing_zone.json.listzonesresponse.zone | length > 0 }}"
        existing_zone_data: "{{ existing_zone.json.listzonesresponse.zone[0] if (existing_zone.json.listzonesresponse.zone is defined and existing_zone.json.listzonesresponse.zone | length > 0) else {} }}"
    
    - name: Fail if Zone exists with different configuration
      fail:
        msg: "Zone '{{ zone_name }}' exists but configuration differs. Expected DNS1={{ zone_dns1 }}, got {{ existing_zone_data.dns1 }}. Delete zone first or update configuration."
      when:
        - zone_exists
        - existing_zone_data.dns1 != zone_dns1 or existing_zone_data.dns2 != zone_dns2 or existing_zone_data.networktype != zone_network_type
    
    - name: Create Zone
      ngine_io.cloudstack.cs_zone:
        api_url: "{{ cs_api_url }}"
        api_key: "{{ cs_api_key }}"
        api_secret: "{{ cs_api_secret }}"
        api_timeout: 60
        name: "{{ zone_name }}"
        dns1: "{{ zone_dns1 }}"
        dns2: "{{ zone_dns2 }}"
        internal_dns1: "{{ zone_internal_dns1 }}"
        internal_dns2: "{{ zone_internal_dns2 }}"
        network_type: "{{ zone_network_type }}"
        guest_cidr_address: "{{ zone_guest_cidr | default(omit) }}"
        state: present
      when: not zone_exists
      register: zone_created
    
    - name: Set zone variable
      set_fact:
        zone: "{{ zone_created if not zone_exists else existing_zone_data }}"
    
    # Physical Networks 생성 (멱등성: 에러 무시)
    - name: Create Physical Networks
      ngine_io.cloudstack.cs_physical_network:
        api_url: "{{ cs_api_url }}"
        api_key: "{{ cs_api_key }}"
        api_secret: "{{ cs_api_secret }}"
        api_timeout: 60
        name: "{{ item.name }}"
        zone: "{{ zone_name }}"
        isolation_method: "{{ item.isolation_methods }}"
        vlan: "{{ item.vlan_range | default(omit) }}"
        state: present
      loop: "{{ cloudstack_physical_networks }}"
      register: physical_networks_result
      failed_when:
        - physical_networks_result.failed is defined
        - physical_networks_result.failed
        - "'Zone is currently enabled' not in (physical_networks_result.msg | default(''))"
        - "'already exists' not in (physical_networks_result.msg | default(''))"
        - "'Physical network with name' not in (physical_networks_result.msg | default(''))"
    
    
    # Traffic Types 추가 (멱등성: 에러 무시)
    - name: Add Traffic Types to Physical Networks
      ngine_io.cloudstack.cs_traffic_type:
        api_url: "{{ cs_api_url }}"
        api_key: "{{ cs_api_key }}"
        api_secret: "{{ cs_api_secret }}"
        api_timeout: 60
        physical_network: "{{ item.0.name }}"
        zone: "{{ zone_name }}"
        traffic_type: "{{ item.1.type }}"
        kvm_networklabel: "{{ item.1.kvm_networklabel }}"
        state: present
      loop: "{{ cloudstack_physical_networks | subelements('traffic_types') }}"
      loop_control:
        label: "{{ item.0.name }} - {{ item.1.type }}"
      register: traffic_types_result
      failed_when:
        - traffic_types_result.failed is defined
        - traffic_types_result.failed
        - "'already exists' not in (traffic_types_result.msg | default(''))"
        - "'not found' not in (traffic_types_result.msg | default(''))"
    
    - name: Enable Physical Networks
      ngine_io.cloudstack.cs_physical_network:
        api_url: "{{ cs_api_url }}"
        api_key: "{{ cs_api_key }}"
        api_secret: "{{ cs_api_secret }}"
        api_timeout: 60
        name: "{{ item.name }}"
        zone: "{{ zone_name }}"
        state: enabled
      loop: "{{ cloudstack_physical_networks }}"
      register: enable_networks_result
      failed_when:
        - enable_networks_result.failed is defined
        - enable_networks_result.failed
        - "'already enabled' not in (enable_networks_result.msg | default(''))"
        - "'Zone is currently enabled' not in (enable_networks_result.msg | default(''))"
    
    # Public IP 범위 조회 (멱등성)
    - name: Check existing Public IP Ranges
      uri:
        url: "{{ cs_api_url }}?command=listVlanIpRanges&zoneid={{ zone.id }}&forvirtualnetwork=true&response=json"
        method: GET
        headers:
          X-API-Key: "{{ cs_api_key }}"
          X-Secret-Key: "{{ cs_api_secret }}"
        return_content: yes
        status_code: 200
      register: existing_public_ip_ranges
      failed_when: false
    
    - name: Build existing public IP ranges list
      set_fact:
        existing_public_ips: "{{ existing_public_ip_ranges.json.listvlaniprangesresponse.vlaniprange | default([]) }}"
    
    # Public IP 범위 추가 (for_virtual_network=true)
    - name: Add Public IP Ranges
      ngine_io.cloudstack.cs_vlan_ip_range:
        api_url: "{{ cs_api_url }}"
        api_key: "{{ cs_api_key }}"
        api_secret: "{{ cs_api_secret }}"
        api_timeout: 60
        zone: "{{ zone_name }}"
        physical_network: "{{ item.physical_network_name }}"
        start_ip: "{{ item.start_ip }}"
        end_ip: "{{ item.end_ip }}"
        gateway: "{{ item.gateway }}"
        netmask: "{{ item.netmask }}"
        vlan: "{{ item.vlan }}"
        for_virtual_network: true
        state: present
      loop: "{{ cloudstack_public_ip_ranges }}"
      when: >
        existing_public_ips | selectattr('startip', 'equalto', item.start_ip) | 
        selectattr('endip', 'equalto', item.end_ip) | list | length == 0
      register: public_ip_ranges_result
      failed_when:
        - public_ip_ranges_result.failed is defined
        - public_ip_ranges_result.failed
        - "'already exists' not in (public_ip_ranges_result.msg | default(''))"
        - "'overlaps with' not in (public_ip_ranges_result.msg | default(''))"
        - "'Physical Network' not in (public_ip_ranges_result.msg | default(''))"
    
    # Pods 생성 (멱등성: 에러 무시)
    - name: Create Pods
      ngine_io.cloudstack.cs_pod:
        api_url: "{{ cs_api_url }}"
        api_key: "{{ cs_api_key }}"
        api_secret: "{{ cs_api_secret }}"
        api_timeout: 60
        name: "{{ item.name }}"
        zone: "{{ zone_name }}"
        start_ip: "{{ item.start_ip }}"
        end_ip: "{{ item.end_ip }}"
        gateway: "{{ item.gateway }}"
        netmask: "{{ item.netmask }}"
        state: present
      loop: "{{ cloudstack_pods }}"
      register: pods_result
      failed_when:
        - pods_result.failed is defined
        - pods_result.failed
        - "'already exists' not in (pods_result.msg | default(''))"
    
    # Clusters 생성 (멱등성: 에러 무시)
    - name: Create Clusters
      ngine_io.cloudstack.cs_cluster:
        api_url: "{{ cs_api_url }}"
        api_key: "{{ cs_api_key }}"
        api_secret: "{{ cs_api_secret }}"
        api_timeout: 60
        name: "{{ item.name }}"
        zone: "{{ zone_name }}"
        pod: "{{ item.pod_name }}"
        hypervisor: "{{ item.hypervisor }}"
        cluster_type: "{{ item.cluster_type }}"
        state: present
      loop: "{{ cloudstack_clusters }}"
      register: clusters_result
      failed_when:
        - clusters_result.failed is defined
        - clusters_result.failed
        - "'already exists' not in (clusters_result.msg | default(''))"
    
    # Hosts 조회 및 추가 (API 인증 이슈로 에러 무시 방식 사용)
    - name: Add KVM Hosts
      ngine_io.cloudstack.cs_host:
        api_url: "{{ cs_api_url }}"
        api_key: "{{ cs_api_key }}"
        api_secret: "{{ cs_api_secret }}"
        api_timeout: 120
        name: "{{ item.name }}"
        cluster: "{{ item.cluster_name }}"
        zone: "{{ zone_name }}"
        pod: "{{ item.pod_name }}"
        hypervisor: "KVM"
        url: "http://{{ item.ip }}"
        username: "{{ item.username }}"
        password: "{{ item.password }}"
        state: present
      loop: "{{ cloudstack_hosts }}"
      loop_control:
        label: "{{ item.name }} ({{ item.ip }})"
      register: hosts_result
      failed_when:
        - hosts_result.failed is defined
        - hosts_result.failed
        - "'already in the database' not in (hosts_result.msg | default(''))"
        - "'is already in the database for resource' not in (hosts_result.msg | default(''))"
    
    # Primary Storage 추가 (멱등성: 에러 무시)
    - name: Add Primary Storages
      ngine_io.cloudstack.cs_storage_pool:
        api_url: "{{ cs_api_url }}"
        api_key: "{{ cs_api_key }}"
        api_secret: "{{ cs_api_secret }}"
        api_timeout: 180
        name: "{{ item.name }}"
        zone: "{{ zone_name }}"
        pod: "{{ item.pod_name }}"
        cluster: "{{ item.cluster_name }}"
        storage_url: "nfs://{{ item.server }}{{ item.path }}"
        scope: "{{ item.scope }}"
        state: present
      loop: "{{ cloudstack_primary_storages }}"
      loop_control:
        label: "{{ item.name }}"
      register: primary_storages_result
    
    # Secondary Storage 추가 (멱등성: 에러 무시)
    - name: Add Secondary Storages
      ngine_io.cloudstack.cs_image_store:
        api_url: "{{ cs_api_url }}"
        api_key: "{{ cs_api_key }}"
        api_secret: "{{ cs_api_secret }}"
        api_timeout: 180
        name: "{{ item.name }}"
        provider: "{{ item.provider }}"
        zone: "{{ zone_name }}"
        url: "nfs://{{ item.server }}{{ item.path }}"
        state: present
      loop: "{{ cloudstack_secondary_storages }}"
      loop_control:
        label: "{{ item.name }}"
      register: secondary_storages_result
    
    - name: Setup complete
      debug:
        msg: "CloudStack Zone setup completed. Web UI: {{ cs_api_url | regex_replace('/client/api', '/client') }}"
