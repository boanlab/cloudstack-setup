---
# KVM 호스트 네트워크 설정 플레이북
# 네트워크 브리지만 별도로 설정하는 플레이북
# 
# Public Network: 공인 IP, SNAT 가능한 대역
# Management Network: 내부 통신 전용 대역

- name: Configure Network Bridges for KVM Hosts
  hosts: kvm-hosts
  become: yes
  gather_facts: yes
  
  tasks:
    - name: Gather network interface information
      shell: ip -o link show | awk -F': ' '{print $2}' | grep -v 'lo\|virbr\|docker\|br-'
      register: available_interfaces
      changed_when: false

    - name: Display available network interfaces
      debug:
        msg:
          - "=== 사용 가능한 네트워크 인터페이스 ==="
          - "{{ available_interfaces.stdout_lines }}"
          - ""
          - "Public Network: 공인 IP, 외부 접근 가능"
          - "Management Network: 내부 통신 전용"

    - name: Check current interface IP addresses
      shell: |
        for iface in $(ip -o link show | awk -F': ' '{print $2}' | grep -v 'lo\|virbr\|docker\|br-'); do
          addr=$(ip -4 addr show $iface | grep -oP '(?<=inet\s)\d+(\.\d+){3}' || echo "No IP")
          echo "$iface: $addr"
        done
      register: interface_ips
      changed_when: false

    - name: Display current interface IPs
      debug:
        msg: "{{ interface_ips.stdout_lines }}"

    - name: Check if interfaces are already configured
      set_fact:
        interfaces_already_set: "{{ public_interface is defined and management_interface is defined }}"

    - name: Prompt for Public Network interface (if not set)
      pause:
        prompt: |
          
          Public Network 인터페이스를 입력하세요 (예: eno1, eth0, enp1s0)
          현재 설정: {{ public_interface | default('미설정') }}
      register: public_interface_input
      when: public_interface is not defined

    - name: Prompt for Management Network interface (if not set)
      pause:
        prompt: |
          
          Management Network 인터페이스를 입력하세요 (예: eno2, eth1, enp2s0)
          현재 설정: {{ management_interface | default('미설정') }}
      register: management_interface_input
      when: management_interface is not defined

    - name: Set interface variables from input
      set_fact:
        public_interface: "{{ public_interface_input.user_input if public_interface is not defined else public_interface }}"
        management_interface: "{{ management_interface_input.user_input if management_interface is not defined else management_interface }}"
      when: public_interface_input.user_input is defined or management_interface_input.user_input is defined

    - name: Validate interface names
      fail:
        msg: "인터페이스 {{ item }}이(가) 존재하지 않습니다."
      when: item not in available_interfaces.stdout
      loop:
        - "{{ public_interface }}"
        - "{{ management_interface }}"

    - name: Check if required IP variables are set
      fail:
        msg: "필수 변수가 설정되지 않았습니다: {{ item }}"
      when: vars[item] is not defined
      loop:
        - public_ip
        - management_ip
        - default_gateway

    - name: Confirm network configuration
      pause:
        prompt: |
          
          === 네트워크 설정 확인 ===
          Public Network (cloudbr1):
            - Interface: {{ public_interface }}
            - IP: {{ public_ip }}/{{ public_netmask | default('16') }}
            - Gateway: {{ default_gateway }}
            - 용도: 공인 IP, 외부 접근
          
          Management Network (cloudbr0):
            - Interface: {{ management_interface }}
            - IP: {{ management_ip }}/{{ management_netmask | default('24') }}
            - 용도: 내부 통신 전용
          
          ⚠️  이 설정을 적용하면 SSH 연결이 끊길 수 있습니다!
          계속하시겠습니까? (yes/no)
      register: confirm_network_change

    - name: Validate confirmation
      fail:
        msg: "네트워크 설정이 취소되었습니다."
      when: confirm_network_change.user_input != "yes"

    - name: Backup existing netplan configuration
      shell: |
        cp /etc/netplan/*.yaml /etc/netplan/backup-$(date +%Y%m%d-%H%M%S).yaml || true
      ignore_errors: yes

    - name: Create network bridge configuration
      template:
        src: ../roles/kvm-host/templates/netplan-bridge.yaml.j2
        dest: /etc/netplan/01-cloudstack-network.yaml
        mode: '0644'

    - name: Test netplan configuration
      command: netplan generate
      register: netplan_test
      failed_when: netplan_test.rc != 0

    - name: Display warning
      debug:
        msg:
          - "⚠️  경고: 네트워크 설정을 적용하면 SSH 연결이 끊길 수 있습니다."
          - "새 IP 주소로 다시 연결해야 할 수 있습니다."
          - "Management IP: {{ management_ip }}"
          - "Public IP: {{ public_ip }}"
          - "10초 후 적용됩니다..."

    - name: Wait before applying
      pause:
        seconds: 10

    - name: Apply netplan configuration
      command: netplan apply
      async: 30
      poll: 0
      ignore_errors: yes

    - name: Wait for network to stabilize
      pause:
        seconds: 15

    - name: Try to reconnect and verify bridges
      shell: ip addr show cloudbr0 && ip addr show cloudbr1
      register: bridge_check
      ignore_errors: yes
      changed_when: false

    - name: Display bridge status
      debug:
        msg: "{{ bridge_check.stdout_lines if bridge_check.rc == 0 else 'Bridge 확인 실패 - 수동으로 확인이 필요합니다' }}"
