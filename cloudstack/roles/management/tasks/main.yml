---
# Management role - CloudStack Management Server 설치

- name: Wait for apt lock to be released
  shell: while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do sleep 1; done
  changed_when: false

- name: Install Java (OpenJDK)
  apt:
    name: "{{ java_package }}"
    state: present

- name: Create CloudStack APT keyring directory
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'

- name: Download CloudStack GPG key
  get_url:
    url: http://packages.shapeblue.com/release.asc
    dest: /tmp/cloudstack-release.asc

- name: Add CloudStack GPG key
  shell: |
    gpg --dearmor < /tmp/cloudstack-release.asc > /etc/apt/keyrings/cloudstack.gpg
  args:
    creates: /etc/apt/keyrings/cloudstack.gpg

- name: Add CloudStack APT repository
  apt_repository:
    repo: "deb [signed-by=/etc/apt/keyrings/cloudstack.gpg] http://packages.shapeblue.com/cloudstack/upstream/debian/4.19 /"
    state: present
    filename: cloudstack

- name: Update apt cache
  apt:
    update_cache: yes

- name: Install CloudStack management and usage packages
  apt:
    name:
      - "cloudstack-management={{ cloudstack_version }}*"
      - "cloudstack-usage={{ cloudstack_version }}*"
    state: present

- name: Create secondary storage mount point
  file:
    path: /mnt/secondary
    state: directory
    mode: '0755'

- name: Mount NFS secondary storage
  mount:
    path: "{{ secondary_storage_mount_path }}"
    src: "{{ nfs_server }}:{{ nfs_secondary_path }}"
    fstype: nfs
    opts: "{{ nfs_mount_options }}"
    state: mounted
  when: 
    - nfs_server is defined
    - mount_secondary_storage | default(true)

- name: Check if SystemVM template is already installed
  stat:
    path: /mnt/secondary/template/tmpl/1
  register: systemvm_template

- name: Install SystemVM template
  shell: |
    /usr/share/cloudstack-common/scripts/storage/secondary/cloud-install-sys-tmplt \
      -m /mnt/secondary \
      -u {{ systemvm_template_url }} \
      -h kvm \
      -s '{{ mysql_root_password }}' \
      -t 3 \
      -F
  args:
    creates: /mnt/secondary/template/tmpl/1/3
  when: 
    - not systemvm_template.stat.exists or force_template_install | default(false)
    - systemvm_template_url is defined
  register: systemvm_install

- name: Check if CloudStack database exists
  shell: mysql -h {{ db_host }} -u root -p'{{ mysql_root_password }}' -e "SHOW DATABASES LIKE 'cloud';" | grep -q cloud
  register: db_exists
  changed_when: false
  failed_when: false

- name: Ensure CloudStack management directory exists
  file:
    path: /var/lib/cloudstack-management
    state: directory
    mode: '0755'

- name: Initialize CloudStack database
  command: >
    cloudstack-setup-databases cloud:cloud@{{ db_host }} 
      --deploy-as=root:{{ mysql_root_password }} 
      -i {{ management_server_ip }}
  when: db_exists.rc != 0
  register: db_init
  notify: restart cloudstack-management
  become: yes
  tags:
    - init-db
  


- name: Create database setup marker
  file:
    path: /var/lib/cloudstack-management/.dbsetup
    state: touch
    mode: '0644'
  when: db_init.changed

- name: Setup CloudStack management server
  command: cloudstack-setup-management
  args:
    creates: /etc/cloudstack/management/server.properties

- name: Ensure CloudStack management is running
  systemd:
    name: cloudstack-management
    state: started
    enabled: yes

- name: Wait for CloudStack management to be ready
  wait_for:
    port: "{{ cloudstack_management_port }}"
    delay: 10
    timeout: 300

- name: Display CloudStack UI access information
  debug:
    msg:
      - "CloudStack Management Server is ready!"
      - "Web UI: http://{{ management_server_ip }}:{{ cloudstack_management_port }}/client"
      - "Default credentials: admin / password"
      - "Check logs: tail -f /var/log/cloudstack/management/management-server.log"
